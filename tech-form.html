<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installation Task Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1F2937; --secondary-color: #4B5563; --accent-color: #3B82F6;
            --background-color: #F3F4F6; --white-color: #FFFFFF; --success-color: #10B981;
            --pending-color: #F59E0B; --cancelled-color: #EF4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Roboto', sans-serif; background-color: var(--background-color);
            color: var(--primary-color); display: flex; justify-content: center;
            align-items: center; min-height: 100vh; padding: 20px;
        }
        .loader {
            border: 8px solid var(--background-color); border-top: 8px solid var(--accent-color);
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .task-container {
            width: 100%; max-width: 500px; background-color: var(--white-color);
            border-radius: 16px; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; display: none; animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .task-header { padding: 20px; background-color: var(--primary-color); color: var(--white-color); text-align: center; }
        .task-header h1 { font-size: 1.5rem; font-weight: 700; }
        .task-body { padding: 25px; }
        .info-group { margin-bottom: 20px; animation: slideUp 0.6s ease-out forwards; opacity: 0; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .info-group:nth-child(2) { animation-delay: 0.1s; } .info-group:nth-child(3) { animation-delay: 0.2s; }
        .info-group:nth-child(4) { animation-delay: 0.3s; }
        .info-group label { display: block; font-size: 0.9rem; font-weight: 500; color: var(--secondary-color); margin-bottom: 6px; }
        .info-group .value { font-size: 1.1rem; padding: 12px; background-color: #F9FAFB; border-radius: 8px; border: 1px solid #E5E7EB; }
        .attachment-section img {
            max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #E5E7EB;
            cursor: pointer; transition: transform 0.3s ease;
        }
        .attachment-section img:hover { transform: scale(1.05); }
        #updateForm { margin-top: 25px; opacity: 0; animation: slideUp 0.6s ease-out 0.4s forwards; }
        #installationStatus {
            width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 500; border-radius: 8px;
            border: 1px solid #D1D5DB; background-color: var(--white-color); -webkit-appearance: none;
            -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%2...%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8em; cursor: pointer;
        }
        .submit-btn {
            width: 100%; padding: 16px; margin-top: 15px; background-color: var(--accent-color);
            border: none; border-radius: 8px; color: var(--white-color); font-size: 1.2rem;
            font-weight: 700; cursor: pointer; transition: all 0.3s ease;
        }
        .submit-btn:hover:not(:disabled) { background-color: #2563EB; transform: translateY(-2px); }
        .submit-btn:disabled { background-color: var(--secondary-color); cursor: wait; }
        .message { padding: 20px; text-align: center; font-size: 1.2rem; display: none; }
        #successMessage { color: var(--success-color); } #errorMessage { color: var(--cancelled-color); }
        
        /* -- Image Modal Styles -- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px); animation: fadeIn 0.3s;
        }
        .modal-content {
            margin: auto; display: block; max-width: 90%; max-height: 90%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .close-modal {
            position: absolute; top: 20px; right: 35px; color: #f1f1f1;
            font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer;
        }
        .close-modal:hover { color: #bbb; }
    </style>
</head>
<body>
    <div id="loader" class="loader"></div>
    <div id="taskContainer" class="task-container">
        </div>
    <div id="successMessage" class="message">Status Updated Successfully!</div>
    <div id="errorMessage" class="message"></div>

    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="fullImage">
    </div>

    <script>
        // --- CONFIGURATION ---
        const AIRTABLE_PAT = 'pat7NcFNg66fUyWbl.b79f56e13480b7b37d257fba01dea131f2716745c259dc069d8959c6d4d9ba62';
        const BASE_ID = 'appqQZoB8R3qOF2d4';
        const SALES_TABLE_ID = 'tbleDNOHiRA42L9V1';
        // --- END CONFIGURATION ---

        const loader = document.getElementById('loader');
        const taskContainer = document.getElementById('taskContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('fullImage');

        const params = new URLSearchParams(window.location.search);
        const recordId = params.get('id');

        async function fetchJobDetails(id) {
            if (!id) { return showError("Error: No Job ID found in the link."); }
            const url = `https://api.airtable.com/v0/${BASE_ID}/${SALES_TABLE_ID}/${id}`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${AIRTABLE_PAT}` } });
                if (!response.ok) { throw new Error(`Could not fetch job details. Status: ${response.status}`); }
                const data = await response.json();
                
                // --- Link Expiry Check ---
                if (data.fields.Link_Generated_At) {
                    const generatedDate = new Date(data.fields.Link_Generated_At);
                    const now = new Date();
                    const hoursDiff = (now - generatedDate) / (1000 * 60 * 60);
                    if (hoursDiff > 24) {
                        return showError("Error: This link has expired after 24 hours.");
                    }
                }
                
                populateForm(data.fields);
                loader.style.display = 'none';
                taskContainer.style.display = 'block';
            } catch (error) { showError(error.message); }
        }

        function populateForm(fields) {
            let attachmentHTML = '';
            if (fields.Tech_Attachment && fields.Tech_Attachment.length > 0) {
                attachmentHTML = `
                    <div class="info-group attachment-section">
                        <label>Attachment</label>
                        <img id="techAttachment" src="${fields.Tech_Attachment[0].url}" alt="Attachment Image">
                    </div>`;
            }

            taskContainer.innerHTML = `
                <div class="task-header"><h1>Installation Task</h1></div>
                <div class="task-body">
                    ${attachmentHTML}
                    <div class="info-group"><label>Customer Name</label><div class="value">${fields.New_Name || 'N/A'}</div></div>
                    <div class="info-group"><label>Customer Number</label><div class="value">${fields.New_Number || 'N/A'}</div></div>
                    <div class="info-group"><label>Service Address</label><div class="value">${fields.Service_Address || 'N/A'}</div></div>
                    <form id="updateForm">
                        <div class="info-group">
                            <label for="installationStatus">Update Installation Status</label>
                            <select id="installationStatus" name="Installation_Status" required>
                                <option value="Pending">Pending</option>
                                <option value="Installed">Installed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">Update Status</button>
                    </form>
                </div>`;
            
            document.getElementById('installationStatus').value = fields.Installation_Status || 'Pending';
            document.getElementById('updateForm').addEventListener('submit', handleFormSubmit);

            // Modal JavaScript
            const techAttachment = document.getElementById('techAttachment');
            if (techAttachment) {
                techAttachment.onclick = function() {
                    modal.style.display = "block";
                    modalImg.src = this.src;
                }
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const submitBtn = event.target.querySelector('.submit-btn');
            submitBtn.textContent = 'Updating...';
            submitBtn.disabled = true;
            const newStatus = document.getElementById('installationStatus').value;
            const url = `https://api.airtable.com/v0/${BASE_ID}/${SALES_TABLE_ID}/${recordId}`;
            const dataToUpdate = { "fields": { "Installation_Status": newStatus } };
            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${AIRTABLE_PAT}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToUpdate)
                });
                if (!response.ok) { throw new Error(`Failed to update status. Status: ${response.status}`); }
                taskContainer.style.display = 'none';
                successMessage.style.display = 'block';
            } catch (error) {
                showError(error.message);
            } finally {
                submitBtn.textContent = 'Update Status';
                submitBtn.disabled = false;
            }
        }

        function showError(msg) {
            loader.style.display = 'none';
            taskContainer.style.display = 'none';
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }

        // --- Script Start ---
        document.addEventListener('DOMContentLoaded', () => fetchJobDetails(recordId));
        document.querySelector('.close-modal').onclick = () => { modal.style.display = "none"; }
    </script>
</body>
</html>
